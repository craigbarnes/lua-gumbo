language: c
env:
    global:
        - LUAROCKS=2.2.0
    matrix:
        - LUA_PKG=lua5.1
        - LUA_PKG=lua5.2
        - LUA_PKG=luajit
branches:
    only:
        - master
before_install:
    - sudo apt-get update -qq
    - sudo apt-get install -y "${LUA_PKG}" luarocks
    - test luajit != "${LUA_PKG}" && sudo apt-get install -y "${LUA_PKG}-dev" || true
    - test luajit = "${LUA_PKG}" && sudo ln -s /usr/bin/luajit-* /usr/bin/luajit || true
    - which lua && lua -v || true
    - which luajit && luajit -v || true
    - bash .travis/setup_gumbo.sh
install:
    - make LUA=$(expr match "$LUA" '^\(.[a-z]*\)')
    - make dist LUA=$(expr match "$LUA" '^\(.[a-z]*\)')
    - sudo
      luarocks make
      gumbo-scm-1.rockspec
      CFLAGS="-O2 -fPIC -ftest-coverage -fprofile-arcs"
      LIBFLAG="-shared --coverage"
script:
    - make check LUA=$(expr match "$LUA" '^\(.[a-z]*\)')
    - make check-install LUA=$(expr match "$LUA" '^\(.[a-z]*\)')
notifications:
    email:
        on_success: change
        on_failure: always
